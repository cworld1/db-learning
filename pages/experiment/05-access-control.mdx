---
title: 05 Mysql access control
---

import { Callout } from "nextra/components";

## ç”¨æˆ·ç®¡ç†

### åˆ›å»ºç”¨æˆ·

æ ¼å¼ï¼š

```sql
CREATE USER [IF NOT EXISTS]
    user [auth_option] [, user [auth_option]] ...
    DEFAULT ROLE role [, role ] ...
    [REQUIRE {NONE | tls_option [[AND] tls_option] ...}]
    [WITH resource_option [resource_option] ...]
    [password_option | lock_option] ...
    [COMMENT 'comment_string' | ATTRIBUTE 'json_object']

user:
    (see Section 6.2.4, â€œSpecifying Account Namesâ€)

auth_option: {
    IDENTIFIED BY 'auth_string' [AND 2fa_auth_option]
  | IDENTIFIED BY RANDOM PASSWORD [AND 2fa_auth_option]
  | IDENTIFIED WITH auth_plugin [AND 2fa_auth_option]
  | IDENTIFIED WITH auth_plugin BY 'auth_string' [AND 2fa_auth_option]
  | IDENTIFIED WITH auth_plugin BY RANDOM PASSWORD [AND 2fa_auth_option]
  | IDENTIFIED WITH auth_plugin AS 'auth_string' [AND 2fa_auth_option]
  | IDENTIFIED WITH auth_plugin [initial_auth_option]
}

tls_option: {
   SSL
 | X509
 | CIPHER 'cipher'
 | ISSUER 'issuer'
 | SUBJECT 'subject'
}

resource_option: {
    MAX_QUERIES_PER_HOUR count
  | MAX_UPDATES_PER_HOUR count
  | MAX_CONNECTIONS_PER_HOUR count
  | MAX_USER_CONNECTIONS count
}

password_option: {
    PASSWORD EXPIRE [DEFAULT | NEVER | INTERVAL N DAY]
  | PASSWORD HISTORY {DEFAULT | N}
  | PASSWORD REUSE INTERVAL {DEFAULT | N DAY}
  | PASSWORD REQUIRE CURRENT [DEFAULT | OPTIONAL]
  | FAILED_LOGIN_ATTEMPTS N
  | PASSWORD_LOCK_TIME {N | UNBOUNDED}
}
```

å¦‚ï¼šï¼š

```sql
create user 'user01' @'localhost' identified by 'user01';
```

<Callout type="warn" emoji="ğŸ›¡ï¸">
  æ³¨ï¼šç”¨æˆ·çš„æ·»åŠ ä¿®æ”¹åˆ é™¤ç­‰æ“ä½œéƒ½æ˜¯åœ¨ root æƒé™ä¸‹æ“ä½œçš„ï¼
</Callout>

å…¶ä¸­ï¼š

- PASSWORDï¼šç”¨äºæŒ‡å®šæ•£åˆ—å£ä»¤ï¼Œå³è‹¥ä½¿ç”¨æ˜æ–‡è®¾ç½®å£ä»¤ï¼Œåˆ™éœ€å¿½ç•¥ PASSWORD å…³é”®å­—ï¼›

  è‹¥ä¸æƒ³ä»¥æ˜æ–‡è®¾ç½®å£ä»¤ï¼Œä¸”çŸ¥é“ PASSWORD() å‡½æ•°è¿”å›ç»™å¯†ç çš„æ•£åˆ—å€¼ï¼Œåˆ™å¯ä»¥åœ¨å£ä»¤è®¾ç½®è¯­å¥ä¸­æŒ‡å®šæ­¤æ•£åˆ—å€¼ï¼Œä½†éœ€è¦åŠ ä¸Šå…³é”®å­— PASSWORDã€‚

- åˆ›å»ºç”¨æˆ·è´¦å·ï¼Œæ ¼å¼ä¸º 'user_name'@'host_nameâ€™ã€‚

  user_name æ˜¯ç”¨æˆ·åï¼Œhost_name ä¸ºä¸»æœºåï¼Œå³ç”¨æˆ·è¿æ¥ MySQL æ—¶æ‰€åœ¨ä¸»æœºçš„åå­—ã€‚
  è‹¥åœ¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œåªç»™å‡ºäº†è´¦æˆ·çš„ç”¨æˆ·åï¼Œè€Œæ²¡æŒ‡å®šä¸»æœºåï¼Œåˆ™ä¸»æœºåé»˜è®¤ä¸ºâ€œ%â€ï¼Œè¡¨ç¤ºä¸€ç»„ä¸»æœº

æ­¤å¤–éœ€è¦æ³¨æ„ï¼š

- å¦‚æœä½¿ç”¨ CREATE USER è¯­å¥æ—¶æ²¡æœ‰ä¸ºç”¨æˆ·æŒ‡å®šå£ä»¤ï¼Œé‚£ä¹ˆ MySQL å…è®¸è¯¥ç”¨æˆ·å¯ä»¥ä¸ä½¿ç”¨å£ä»¤ç™»å½•ç³»ç»Ÿï¼Œç„¶è€Œä»å®‰å…¨çš„è§’åº¦è€Œè¨€ï¼Œä¸æ¨èè¿™ç§åšæ³•ã€‚
- ä½¿ç”¨ CREATE USER è¯­å¥å¿…é¡»æ‹¥æœ‰ MySQL ä¸­ mysql æ•°æ®åº“çš„ INSERT æƒé™æˆ–å…¨å±€ CREATE USER æƒé™ã€‚
- ä½¿ç”¨ CREATE USER è¯­å¥åˆ›å»ºä¸€ä¸ªç”¨æˆ·è´¦å·åï¼Œä¼šåœ¨ç³»ç»Ÿè‡ªèº«çš„ MySQL æ•°æ®åº“çš„ user è¡¨ä¸­æ·»åŠ ä¸€æ¡æ–°è®°å½•ã€‚è‹¥åˆ›å»ºçš„è´¦æˆ·å·²ç»å­˜åœ¨ï¼Œåˆ™è¯­å¥æ‰§è¡Œæ—¶ä¼šå‡ºç°é”™è¯¯ã€‚
- æ–°åˆ›å»ºçš„ç”¨æˆ·æ‹¥æœ‰çš„æƒé™å¾ˆå°‘ã€‚ä»–ä»¬å¯ä»¥ç™»å½• MySQLï¼Œåªå…è®¸è¿›è¡Œä¸éœ€è¦æƒé™çš„æ“ä½œï¼Œå¦‚ä½¿ç”¨ SHOW è¯­å¥æŸ¥è¯¢æ‰€æœ‰å­˜å‚¨å¼•æ“å’Œå­—ç¬¦é›†çš„åˆ—è¡¨ç­‰ã€‚
- å¦‚æœä¸¤ä¸ªç”¨æˆ·å…·æœ‰ç›¸åŒçš„ç”¨æˆ·åå’Œä¸åŒçš„ä¸»æœºåï¼ŒMySQL ä¼šå°†ä»–ä»¬è§†ä¸ºä¸åŒçš„ç”¨æˆ·ï¼Œå¹¶å…è®¸ä¸ºè¿™ä¸¤ä¸ªç”¨æˆ·åˆ†é…ä¸åŒçš„æƒé™é›†åˆã€‚

### æ›´æ”¹ç”¨æˆ·

æ›´æ”¹ç”¨æˆ·ä¿¡æ¯ä¸»è¦åŒ…æ‹¬é‡å‘½åï¼Œæ”¹å¯†ç ï¼Œé”å®šæˆ–è§£é”ç”¨æˆ·ã€‚ä¸‹é¢å°†é€šè¿‡æ¡ˆä¾‹ä¸ºå¤§å®¶å±•ç¤ºè¿™äº›ç”¨æ³•ï¼š

```sql
# é‡å‘½åç”¨æˆ·
RENAME USER 'test user'@'%'to 'test'@'%';
# ä¿®æ”¹å¯†ç 
ALTER USER 'test'@'%'identified by '123456789';
# é”å®šæˆ–è§£é”ç”¨æˆ·
ALTER USER 'test'@'%'ACCOUNT LOCK;
ALTER USER 'test'@'%'ACCOUNT UNLOCK;
```

### åˆ é™¤ç”¨æˆ·

**æ–¹æ³•ä¸€**ï¼šä½¿ç”¨ SQL è‡ªå¸¦åŠŸèƒ½åˆ é™¤

æ ¼å¼ï¼š

```sql
DROP USER [IF EXISTS] user [, user] ...
```

å¦‚ï¼š

```sql
DROP USER jeffrey'@'localhost'
```

**æ–¹æ³•äºŒ**ï¼šä½¿ç”¨ DELETE è¯­å¥åˆ é™¤

```sql
DELETE FROM mysql.user
WHERE user='tom' AND host='localhost';
-- æ³¨æ„è¿˜è¦æ›´æ–°æˆæƒè¡¨ï¼š
FLUSH PRIVILEGES;
```

## æƒé™ç®¡ç†

- å¯¹ç™»å½•åˆ° MySQL çš„ç”¨æˆ·è¿›è¡Œæƒé™éªŒè¯ã€‚
- æ‰€æœ‰ç”¨æˆ·çš„æƒé™éƒ½å­˜å‚¨åœ¨ MySQL çš„æƒé™è¡¨ä¸­ï¼Œä¸åˆç†çš„æƒé™è§„åˆ’ä¼šç»™ MySQL æœåŠ¡å™¨å¸¦æ¥å®‰å…¨éšæ‚£ã€‚
- MySQL æƒé™ç³»ç»Ÿå¯éªŒè¯è¿æ¥åˆ°ä¸€å°ç»™å®šä¸»æœºçš„ç”¨æˆ·ï¼Œå¹¶ä¸”èµ‹äºˆè¯¥ç”¨æˆ·åœ¨å„ç±»æƒé™ã€‚
- è´¦æˆ·æƒé™ä¿¡æ¯è¢«å­˜å‚¨åœ¨ MySQL æ•°æ®åº“çš„ Â  userã€dbã€hostã€tables_privã€column_priv å’Œ procs_priv è¡¨ä¸­ã€‚
- MySQL å¯åŠ¨æ—¶ï¼ŒæœåŠ¡å™¨å°†è¿™äº›æ•°æ®åº“è¡¨ä¸­çš„æƒé™ä¿¡æ¯çš„å†…å®¹è¯»å…¥å†…å­˜ã€‚

### åˆ›å»ºè§’è‰²

[CREATE ROLE](https://dev.mysql.com/doc/refman/8.0/en/create-role.html) creates one or more roles, which are named collections of privileges.

æ ¼å¼ï¼š

```sql
CREATE ROLE [IF NOT EXISTS] role [, role] ...
```

å¦‚ï¼š

```sql
CREATE ROLE 'administrator','developer';
CREATE ROLE 'webapp'@'localhost';
```

### åˆ é™¤è§’è‰²

```sql
DROP ROLE [IF EXISTS] role [, role]...
```

### æƒé™

![image-20230510144850194](./05-access-control.assets/image-20230510144850194.png)

### ç”¨æˆ·æˆæƒ

æˆæƒç”¨æˆ·ï¼š

```sql
GRANT priv_type [(column_list)]
[, priv_type [(column_list)]]
ON [object_type] priv_level
TO user_or_role [, user_or_role]
[WITH GRANT OPTION]
[AS user
	[WITH ROLE
         DEFAULT | NONE | ALL
         | ALL EXCEPT role [, role ] ...
         | role [, role ï¼½...
    ]
]
```

æˆæƒè§’è‰²ï¼š

```sql
GRANT role [role] ...
TO user_or_role [user_or_role]...
[WITH ADMIN OPTION]
```

å¦‚æˆæƒç”¨æˆ·ï¼š

```sql
GRANT ALL ON db1.* TO 'jeffrey'@'localhost';
GRANT 'role1', 'role2'
TO 'user1'@'localhost', 'user2'@'localhost';
GRANT SELECT ON world.* TO 'role3';
```

å¦‚æˆæƒè§’è‰²ï¼š

```sql
CREATE USER 'jeffrey'@'localhost' IDENTIFIED BY 'password';
GRANT ALL ON db1.* TO 'jeffrey'@'localhost';
GRANT SELECT ON db2.invoice To 'jeffrey'@'localhost';
ALTER USER 'jeffrey'@'localhost' WITH MAX_QUERIES_PER_HOUR 90;
```

### æƒé™åˆ†çº§

- å…¨å±€å±‚çº§
- æ•°æ®åº“å±‚çº§
- è¡¨å±‚çº§
- åˆ—å±‚çº§
- å­ç¨‹åºå±‚çº§

#### å…¨å±€å±‚çº§

Global privileges

Global privileges are administrative or apply to all databases on a given server. To assign global privileges,use on \*.syntax:

```sql
GRANT ALL ON *.TO someuser'@'somehost';
GRANT SELECT,INSERT ON *.TO 'someuser'@'somehost';
```

æ³¨ï¼šå­˜å‚¨åœ¨ mysql.user è¡¨ä¸­

#### æ•°æ®åº“å±‚çº§

Database privileges

Database privileges apply to all objects in a given database.To assign database-level privileges,use on db_name.syntax:

```sql
GRANT ALL ON mydb.* TO someuser'@'somehost';
GRANT SELECT, INSERT ON mydb.* TO someuser'@'somehost';
```

æ³¨ï¼šå­˜å‚¨åœ¨ mysql.db å’Œ mysql.host è¡¨ä¸­

#### åˆ—å±‚çº§

Column privileges

Column privileges apply to single columns in a given table.Each privilege to be granted at the column level must be followed by the column or columns,enclosed within parentheses.

```sql
GRANT SELECT (col1), INSERT (col1,col2) ON mydb.mytbl TO someuser'@'somehost';
```

æ³¨ï¼šå­˜å‚¨åœ¨ mysql.columns_priv è¡¨ä¸­

#### å­ç¨‹åºå±‚çº§

Stored Routine Privileges

The `ALTER ROUTINE`, `CREATE ROUTINE`, `EXECUTE` and `GRANT OPTION` privileges apply to stored routines (procedures and functions). They can be granted at the global and database levels. Except for `CREATE ROUTINE`, these privileges can be granted at the routine level for individual routines.

GRANT CREA

```sql
GRANT CREATE ROUTINE ON mydb.* TO 'someuser'@'somehost';
GRANT EXECUTE ON PROCEDURE mydb.myproc TO someuser'@'somehost';
```

æ³¨ï¼šå­˜å‚¨åœ¨ mysql.procs_priv è¡¨ä¸­

MySQL æƒé™è¡¨çš„éªŒè¯è¿‡ç¨‹ä¸ºï¼š

1. å…ˆä» user è¡¨ä¸­çš„ Host, User, Password è¿™ 3 ä¸ªå­—æ®µä¸­åˆ¤æ–­è¿æ¥çš„ ipã€ç”¨æˆ·åã€å¯†ç å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™é€šè¿‡éªŒè¯ã€‚

2. é€šè¿‡èº«ä»½è®¤è¯åï¼Œè¿›è¡Œæƒé™åˆ†é…ï¼ŒæŒ‰ç…§ userï¼Œdbï¼Œtables_privï¼Œcolumns_privï¼Œ mysql.procs_priv çš„é¡ºåºè¿›è¡ŒéªŒè¯ã€‚

   å³å…ˆæ£€æŸ¥å…¨å±€æƒé™è¡¨ userï¼Œå¦‚æœ user ä¸­å¯¹åº”çš„æƒé™ä¸º Yï¼Œåˆ™æ­¤ç”¨æˆ·å¯¹æ‰€æœ‰æ•°æ®åº“çš„æƒé™éƒ½ä¸º Yï¼Œå°†ä¸å†æ£€æŸ¥ db, tables_priv,columns_privï¼›

   å¦‚æœä¸º Nï¼Œåˆ™åˆ° db è¡¨ä¸­æ£€æŸ¥æ­¤ç”¨æˆ·å¯¹åº”çš„å…·ä½“æ•°æ®åº“ï¼Œå¹¶å¾—åˆ° db ä¸­ä¸º Y çš„æƒé™ï¼›

   å¦‚æœ db ä¸­ä¸º Nï¼Œåˆ™æ£€æŸ¥ tables_priv ä¸­æ­¤æ•°æ®åº“å¯¹åº”çš„å…·ä½“è¡¨ï¼Œå–å¾—è¡¨ä¸­çš„æƒé™ Yï¼Œä»¥æ­¤ç±»æ¨ã€‚

### æŸ¥çœ‹ç”¨æˆ·æƒé™

æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·ï¼š

```sql
SELECT user,host FROM mysql.user;
```

æŸ¥çœ‹å•ä¸ªç”¨æˆ·æ‰€æœ‰æƒ…å†µï¼š

```sql
SELECT * FROM mysql.user WHERE user='root'\G
-- \g ç›¸å½“äº â€™;â€™
-- \G ä½¿æ¯ä¸ªå­—æ®µæ‰“å°åˆ°å•ç‹¬çš„è¡Œï¼Œä¹Ÿæœ‰ â€™;â€™ çš„ä½œç”¨
```

ä¸€å…±æœ‰è¿™äº›ï¼š

![image-20230520212234543](./05-access-control.assets/image-20230520212234543.png)

çœ‹è‡ªå·±çš„æƒé™ï¼š

```sql
SHOW GRANTS\G
```

çœ‹åˆ«äººçš„æƒé™ï¼š

```sql
SHOW GRANTS FOR tom@'localhost'\G
```

## è§’è‰²ã€ç”¨æˆ·æˆæƒ

æˆæƒï¼š

```sql
GRANT 'role1','role2' TO 'user1'@'localhost','user2'@'localhost';
```

æ”¶å›æƒé™ï¼š

```sql
REVOKE
	priv_type [(column_list)]
		[priv_type [(column_list)]] ...
	ON [object_type]priv_level
	FROM user_or_role [user_or_role] ...

REVOKE ALL [PRIVILEGES],GRANT OPTION
	FROM user_or_role [user_or_role] ...
```

å¦‚ï¼š

```sql
REVOKE INSERT ON *FROM 'jeffrey'@'localhost';
REVOKE 'role1','role2' FROM 'user1'@'localhost', 'user2'@'localhost';
REVOKE SELECT ON world.FROM 'role3';
```

### æŸ¥è¯¢æƒé™

```sql
SHOW GRANTS
	[FOR user_or_role [USING role [role] ... ]]

user_or_role: {
	user (see Section 6.2.4,"Specifying Account Names")
	| role (see Section 6.2.5,"Specifying Role Names"
}
```

å¦‚ï¼š

```sql
SHOW GRANTS FOR jeffrey'@'localhost';
```
